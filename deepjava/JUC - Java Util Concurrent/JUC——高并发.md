<strong>JUC</strong>æ ¸å¿ƒç»„ä»¶<em>CheatSheet</em>
## äºŒã€<a>JUC</a> æ ¸å¿ƒç»„ä»¶æ¦‚è§ˆï¼ˆä»ç®€å•åˆ°å¤æ‚ï¼‰

| ç±»åˆ«           | æ ¸å¿ƒç±»/æ¥å£                                                   | ç”¨é€”                  |
| ------------ | -------------------------------------------------------- | ------------------- |
| **1. åŸå­å˜é‡**  | `AtomicInteger`, `AtomicReference`                       | æ— é”åŸå­æ“ä½œ              |
| **2. æ˜¾å¼é”**   | `ReentrantLock`, `ReadWriteLock`                         | æ›¿ä»£ synchronizedï¼Œæ›´çµæ´» |
| **3. çº¿ç¨‹æ± **   | `ExecutorService`, `ThreadPoolExecutor`                  | ç®¡ç†çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ            |
| **4. å¹¶å‘é›†åˆ**  | `ConcurrentHashMap`, `CopyOnWriteArrayList`              | çº¿ç¨‹å®‰å…¨é›†åˆ              |
| **5. åŒæ­¥å·¥å…·ç±»** | `CountDownLatch`, `CyclicBarrier`, `Semaphore`, `Phaser` | çº¿ç¨‹åä½œ                |
| **6. å¼‚æ­¥ç¼–ç¨‹**  | `Future`, `CompletableFuture`                            | å¼‚æ­¥ä»»åŠ¡ä¸ç»„åˆ             |
| **7. é«˜çº§åŒæ­¥å™¨** | `AQS (AbstractQueuedSynchronizer)`                       | JUC åº•å±‚åŸºçŸ³            |
## åŸå­å˜é‡ AtomicXXX
> ç”¨äºå•ä¸ªå˜é‡çš„ é«˜æ•ˆã€çº¿ç¨‹å®‰å…¨ æ“ä½œ

åŸå­ç±»éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä»–ä»¬éƒ½æ˜¯åŸºäºCASå®ç°çš„

å¸¸ç”¨ç±»ï¼š
<ui>
<li><mark>AtomicInteger </mark>/ AtomicLongï¼šæ•´æ•°åŸå­æ“ä½œ</li>
<li>AtomicBooleanï¼šå¸ƒå°”å€¼</li>
<li>AtomicReference<T>ï¼šå¼•ç”¨ç±»å‹</li>
<li>AtomicStampedReferenceï¼šè§£å†³ABAé—®é¢˜</li>
</ui>
âœ… **é€‚ç”¨åœºæ™¯**ï¼šè®¡æ•°å™¨ã€çŠ¶æ€æ ‡å¿—ã€åºåˆ—å·ç”Ÿæˆã€‚
### CASçš„åŸç†
>CAS æ“ä½œåŒ…å«ä¸‰ä¸ªæ“ä½œæ•° â€”â€” å†…å­˜ä½ç½®ï¼ˆVï¼‰ã€é¢„æœŸåŸå€¼ï¼ˆAï¼‰å’Œæ–°å€¼(B)ã€‚å¦‚æœå†…å­˜ä½ç½®çš„å€¼Vä¸é¢„æœŸåŸå€¼Aç›¸åŒ¹é…ï¼Œé‚£ä¹ˆå¤„ç†å™¨ä¼šè‡ªåŠ¨å°†è¯¥ä½ç½®å€¼Væ›´æ–°ä¸ºæ–°å€¼Bï¼Œå¦åˆ™ï¼Œå¤„ç†å™¨ä¸åšä»»ä½•æ“ä½œï¼Œæ•´ä¸ªæ“ä½œä¿è¯äº†åŸå­æ€§ï¼Œå³åœ¨å¯¹æ¯”V==Aåã€è®¾ç½®V=Bä¹‹å‰ä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹ä¿®æ”¹Vçš„å€¼ã€‚

###  **CAS çš„æœ¬è´¨ï¼šç«äº‰è€Œéé˜»æ­¢**
```java
// CAS çš„åŸç†
public final boolean compareAndSet(int expect, int update) {
    // åŸå­æ“ä½œï¼šæ¯”è¾ƒå¹¶äº¤æ¢
    // å¦‚æœå½“å‰å€¼ == expectï¼Œåˆ™è®¾ç½®ä¸º update
    // å¦åˆ™ä»€ä¹ˆéƒ½ä¸åšï¼Œè¿”å› false
}
```
### å¤šçº¿ç¨‹åŒæ—¶æ‰§è¡ŒCAS
```java
AtomicInteger counter = new AtomicInteger(0);

// çº¿ç¨‹Aå’Œçº¿ç¨‹BåŒæ—¶æ‰§è¡Œï¼š
Thread A: counter.compareAndSet(0, 1)  // æˆåŠŸ âœ“
Thread B: counter.compareAndSet(0, 1)  // å¤±è´¥ âœ—

// çº¿ç¨‹Bå¤±è´¥çš„åŸå› ï¼š
// 1. çº¿ç¨‹Aå…ˆæŠŠå€¼ä»0æ”¹æˆäº†1
// 2. çº¿ç¨‹Bæ‰§è¡Œæ—¶ï¼Œå½“å‰å€¼å·²ç»æ˜¯1ï¼Œä¸ç­‰äºæœŸæœ›å€¼0
// 3. æ‰€ä»¥CASå¤±è´¥
```

## æ˜¾å¼é”
### 1.ReentrantLockï¼ˆå¯é‡å…¥é”ï¼‰
```java
ReentrantLock lock = new ReentrantLock();
lock.lock();
try {
	//ä¸´ç•ŒåŒº
}finally {
	lock.unlock(); // å¿…é¡»åœ¨finallyä¸­é‡Šæ”¾ï¼
}
```
ç›¸è¾ƒäºsynchronizedï¼š
<ui>
<li>å¯ä¸­æ–­</li>
<li>è¶…æ—¶</li>
<li>å…¬å¹³é”</li>
<li>å¤šæ¡ä»¶</li>
</ui>
### å¹¶å‘é”åŠŸèƒ½å«ä¹‰è¡¨

#### 1. **å¯ä¸­æ–­ (Interruptible)**
**å«ä¹‰**ï¼šçº¿ç¨‹åœ¨ç­‰å¾…è·å–é”çš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥è¢«å…¶ä»–çº¿ç¨‹ä¸­æ–­ï¼ˆè°ƒç”¨ `interrupt()` æ–¹æ³•ï¼‰ï¼Œä»è€Œé€€å‡ºç­‰å¾…çŠ¶æ€å¹¶æŠ›å‡º `InterruptedException`ã€‚

**ä»·å€¼**ï¼šå®ç°ä»»åŠ¡å–æ¶ˆæœºåˆ¶ï¼Œé˜²æ­¢çº¿ç¨‹æ— é™æœŸç­‰å¾…ã€‚

---
#### 2. **è¶…æ—¶ (Timeout)**
**å«ä¹‰**ï¼šçº¿ç¨‹å°è¯•è·å–é”æ—¶ï¼Œå¯ä»¥è®¾ç½®æœ€é•¿ç­‰å¾…æ—¶é—´ã€‚å¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰è·å–åˆ°é”ï¼Œå°±æ”¾å¼ƒç­‰å¾…å¹¶è¿”å›å¤±è´¥ï¼Œè€Œä¸æ˜¯ä¸€ç›´é˜»å¡ã€‚

**ä»·å€¼**ï¼šé¿å…æ­»é”ï¼Œæé«˜ç³»ç»Ÿå“åº”æ€§ï¼Œå®ç°ä¼˜é›…é™çº§ã€‚

---
#### 3. **å…¬å¹³é” (Fair Lock)**
**å«ä¹‰**ï¼šæŒ‰ç…§çº¿ç¨‹ç­‰å¾…é”çš„æ—¶é—´é•¿çŸ­æ¥åˆ†é…é”ã€‚ç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹ä¼˜å…ˆè·å¾—é”ï¼Œéµå¾ª"å…ˆæ¥å…ˆå¾—"åŸåˆ™ã€‚

**ä»·å€¼**ï¼šé˜²æ­¢çº¿ç¨‹é¥¥é¥¿ï¼Œä¿è¯å…¬å¹³æ€§ï¼ˆä½†ä¼šé™ä½ååé‡ï¼‰ã€‚

---
#### 4. **å¤šæ¡ä»¶ (Multiple Conditions)**
**å«ä¹‰**ï¼šä¸€ä¸ªé”å¯ä»¥å…³è”å¤šä¸ªæ¡ä»¶é˜Ÿåˆ—ï¼ˆConditionï¼‰ï¼Œä¸åŒæ¡ä»¶çš„çº¿ç¨‹å¯ä»¥åœ¨ä¸åŒçš„é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œå¯ä»¥ç²¾ç¡®å”¤é†’ç‰¹å®šæ¡ä»¶çš„çº¿ç¨‹ã€‚

**ä»·å€¼**ï¼šé¿å…"æƒŠç¾¤æ•ˆåº”"ï¼Œæé«˜å”¤é†’æ•ˆç‡ï¼Œå®ç°æ›´ç²¾ç»†çš„çº¿ç¨‹åä½œã€‚


### ReadWriteLockï¼ˆè¯»å†™é”)
<ui>
<li>è¯»-è¯»å…±äº«</li>
<li>è¯»-å†™äº’æ–¥ï¼Œå†™-å†™äº’æ–¥</li>
</ui>
```java
ReadWriteLock rwLock = new ReentrantReadWriteLock();
Lock readLock = rwLock.readLock();
Lock writeLock = rwLock.writeLock();
```

âœ… **é€‚ç”¨åœºæ™¯**ï¼šç¼“å­˜ã€é…ç½®ä¸­å¿ƒï¼ˆè¯»å¤šå†™å°‘ï¼‰

## çº¿ç¨‹æ± ï¼ˆExecutoræ¡†æ¶ï¼‰--- ç®¡ç†çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ

>æ ¸å¿ƒæ€æƒ³ï¼šçº¿ç¨‹å¤ç”¨ï¼Œé¿å…é¢‘ç¹åˆ›å»º/é”€æ¯

<em>æ¨èï¼š</em> æ‰‹åŠ¨åˆ›å»º<code>ThreadPoolExecutor</code>
```java
new ThreadPoolExecutor(
	2,
	4,
	60L,TimeUnit.SECONDS,
	new LinkedBlockingQueue<>(100) // æœ‰ç•Œé˜Ÿåˆ—
	new ThreadFactory(),
	new ThreadPoolExecutor.CallerRunsPolicy() // æ‹’ç»ç­–ç•¥
)
```
### çº¿ç¨‹æ± å·¥ä½œæµç¨‹
#### ThreadPoolExecutor å‚æ•°è¯¦è§£

```java
new ThreadPoolExecutor(
    2,                // æ ¸å¿ƒçº¿ç¨‹æ•° (corePoolSize)
    4,                // æœ€å¤§çº¿ç¨‹æ•° (maximumPoolSize)
    60L, TimeUnit.SECONDS, // ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ (keepAliveTime)
    new LinkedBlockingQueue<>(100), // å·¥ä½œé˜Ÿåˆ—
    new ThreadFactory(),   // çº¿ç¨‹å·¥å‚
    new ThreadPoolExecutor.CallerRunsPolicy() // æ‹’ç»ç­–ç•¥
);
```
#### ğŸ“Š **å‚æ•°å«ä¹‰ä¸å·¥ä½œæµç¨‹**

##### 1. **æ ¸å¿ƒçº¿ç¨‹æ•° (corePoolSize: 2)**
- **å«ä¹‰**ï¼šçº¿ç¨‹æ± ä¸­å§‹ç»ˆä¿æŒå­˜æ´»çš„çº¿ç¨‹æ•°é‡
- **ç‰¹ç‚¹**ï¼šå³ä½¿ç©ºé—²ä¹Ÿä¸ä¼šè¢«å›æ”¶ï¼ˆé™¤éè®¾ç½® `allowCoreThreadTimeOut(true)`ï¼‰
- **æœ¬ä¾‹**ï¼šè‡³å°‘æœ‰ 2 ä¸ªçº¿ç¨‹éšæ—¶å¾…å‘½

##### 2. **æœ€å¤§çº¿ç¨‹æ•° (maximumPoolSize: 4)**
- **å«ä¹‰**ï¼šçº¿ç¨‹æ± å…è®¸åˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°é‡
- **å·¥ä½œæ—¶æœº**ï¼šå½“ä»»åŠ¡é˜Ÿåˆ—æ»¡äº†ï¼Œæ‰ä¼šåˆ›å»ºæ–°çº¿ç¨‹ï¼ˆæœ€å¤šåˆ° 4 ä¸ªï¼‰
- **æœ¬ä¾‹**ï¼šå½“é˜Ÿåˆ—æ»¡ä¸”æœ‰æ–°ä»»åŠ¡æ—¶ï¼Œä¼šåˆ›å»ºç¬¬ 3ã€4 ä¸ªçº¿ç¨‹

##### 3. **ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ (keepAliveTime: 60ç§’)**
- **å«ä¹‰**ï¼šè¶…å‡ºæ ¸å¿ƒçº¿ç¨‹æ•°çš„ç©ºé—²çº¿ç¨‹ï¼Œå¤šä¹…åè¢«å›æ”¶
- **ä½œç”¨å¯¹è±¡**ï¼šåªé’ˆå¯¹ `è¶…è¿‡ corePoolSize çš„çº¿ç¨‹`
- **æœ¬ä¾‹**ï¼šç¬¬ 3ã€4 å·çº¿ç¨‹å¦‚æœç©ºé—²è¶…è¿‡ 60 ç§’ï¼Œä¼šè¢«é”€æ¯

##### 4. **å·¥ä½œé˜Ÿåˆ— (workQueue: LinkedBlockingQueue(100))**
- **å«ä¹‰**ï¼šå­˜æ”¾å¾…æ‰§è¡Œä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—
- **é˜Ÿåˆ—è¡Œä¸º**ï¼š
  - æœ‰ç•Œé˜Ÿåˆ—ï¼ˆå®¹é‡ 100ï¼‰
  - é˜Ÿåˆ—æ»¡æ—¶ï¼Œæ–°ä»»åŠ¡ä¼šè§¦å‘åˆ›å»ºæ–°çº¿ç¨‹ï¼ˆç›´åˆ° maxPoolSizeï¼‰
- **æœ¬ä¾‹æµç¨‹**ï¼š
  1. ä»»åŠ¡æ•° â‰¤ 2 â†’ æ ¸å¿ƒçº¿ç¨‹å¤„ç†
  2. ä»»åŠ¡æ•° 3-102 â†’ æ ¸å¿ƒçº¿ç¨‹å¤„ç†ï¼Œå¤šä½™ä»»åŠ¡è¿›é˜Ÿåˆ—
  3. ä»»åŠ¡æ•° 103-106 â†’ åˆ›å»ºæ–°çº¿ç¨‹ï¼ˆæœ€å¤§åˆ° 4 ä¸ªï¼‰
  4. ä»»åŠ¡æ•° > 106 â†’ è§¦å‘æ‹’ç»ç­–ç•¥

##### 5. **çº¿ç¨‹å·¥å‚ (ThreadFactory)**
- **å«ä¹‰**ï¼šç”¨äºåˆ›å»ºæ–°çº¿ç¨‹ï¼Œå¯ä»¥è‡ªå®šä¹‰çº¿ç¨‹åã€ä¼˜å…ˆçº§ç­‰
- **å¸¸è§ç”¨æ³•**ï¼š
```java
ThreadFactory factory = new ThreadFactory() {
    private AtomicInteger count = new AtomicInteger(1);
    public Thread newThread(Runnable r) {
        return new Thread(r, "MyThread-" + count.getAndIncrement());
    }
};
```

##### 6. **æ‹’ç»ç­–ç•¥ (RejectedExecutionHandler: CallerRunsPolicy)**
- **è§¦å‘æ—¶æœº**ï¼šå½“ `é˜Ÿåˆ—å·²æ»¡` ä¸” `çº¿ç¨‹æ•°è¾¾åˆ° maximumPoolSize`
- **å››ç§ç­–ç•¥**ï¼š
  - **AbortPolicy**ï¼ˆé»˜è®¤ï¼‰ï¼šæŠ›å‡º `RejectedExecutionException`
  - **CallerRunsPolicy**ï¼šè®©æäº¤ä»»åŠ¡çš„çº¿ç¨‹è‡ªå·±æ‰§è¡Œ
  - **DiscardPolicy**ï¼šç›´æ¥ä¸¢å¼ƒæ–°ä»»åŠ¡ï¼ˆä¸é€šçŸ¥ï¼‰
  - **DiscardOldestPolicy**ï¼šä¸¢å¼ƒé˜Ÿåˆ—ä¸­æœ€è€çš„ä»»åŠ¡ï¼Œç„¶åé‡è¯•

---

##### ğŸ”„ **çº¿ç¨‹æ± å·¥ä½œæµç¨‹å›¾**
```
æ–°ä»»åŠ¡æäº¤
    â†“
å½“å‰çº¿ç¨‹æ•° < corePoolSize? (2)
    â”œâ”€â”€ æ˜¯ â†’ åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œ
    â†“
   å¦
    â†“
é˜Ÿåˆ—æœªæ»¡? (100)
    â”œâ”€â”€ æ˜¯ â†’ ä»»åŠ¡å…¥é˜Ÿåˆ—ç­‰å¾…
    â†“
   å¦
    â†“
å½“å‰çº¿ç¨‹æ•° < maximumPoolSize? (4)
    â”œâ”€â”€ æ˜¯ â†’ åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œ
    â†“
   å¦
    â†“
æ‰§è¡Œæ‹’ç»ç­–ç•¥ (CallerRunsPolicy)
```

---

##### ğŸ“ **å®é™…æ‰§è¡Œç¤ºä¾‹**

##### åœºæ™¯ï¼šæ¯ç§’æ¥ 150 ä¸ªä»»åŠ¡
```
æ—¶é—´çº¿ï¼š
1. ä»»åŠ¡1-2 â†’ æ ¸å¿ƒçº¿ç¨‹1ã€2æ‰§è¡Œ
2. ä»»åŠ¡3-102 â†’ è¿›å…¥é˜Ÿåˆ—ç­‰å¾…ï¼ˆ100ä¸ªï¼‰
3. ä»»åŠ¡103-104 â†’ åˆ›å»ºçº¿ç¨‹3ã€4æ‰§è¡Œï¼ˆè¾¾åˆ°maxï¼‰
4. ä»»åŠ¡105 â†’ é˜Ÿåˆ—å·²æ»¡ï¼Œçº¿ç¨‹æ•°å·²æ»¡
   â†’ è§¦å‘CallerRunsPolicyï¼šä¸»çº¿ç¨‹è‡ªå·±æ‰§è¡Œ
5. ä»»åŠ¡106 â†’ ä¸»çº¿ç¨‹è‡ªå·±æ‰§è¡Œ
...
```

##### ç©ºé—²æ—¶ï¼š
- çº¿ç¨‹1ã€2ï¼ˆæ ¸å¿ƒï¼‰ â†’ ä¸€ç›´å­˜æ´»
- çº¿ç¨‹3ã€4ï¼ˆé¢å¤–ï¼‰ â†’ ç©ºé—²60ç§’åè‡ªåŠ¨é”€æ¯

---

##### âš¡ **å‚æ•°é…ç½®å»ºè®®**

| åœºæ™¯         | core    | max     | é˜Ÿåˆ—    | ç­–ç•¥               |
| ---------- | ------- | ------- | ----- | ---------------- |
| **CPUå¯†é›†å‹** | CPUæ ¸æ•°   | CPUæ ¸æ•°+1 | æ— ç•Œé˜Ÿåˆ—  | AbortPolicy      |
| **IOå¯†é›†å‹**  | 2Ã—CPUæ ¸æ•° | æ›´å¤š      | æœ‰ç•Œé˜Ÿåˆ—  | CallerRunsPolicy |
| **å¿«é€Ÿå“åº”**   | è¾ƒå°      | è¾ƒå¤§      | åŒæ­¥é˜Ÿåˆ—  | CallerRunsPolicy |
| **æ‰¹é‡å¤„ç†**   | è¾ƒå°      | è¾ƒå°      | å¤§å®¹é‡é˜Ÿåˆ— | DiscardPolicy    |

**å…³é”®ç‚¹**ï¼šä½ çš„é…ç½®ï¼ˆcore=2, max=4, queue=100ï¼‰é€‚åˆ**IOå¯†é›†å‹ã€æœ‰çªå‘æµé‡çš„åœºæ™¯**ï¼Œèƒ½å¤Ÿå¹³æ»‘å¤„ç†å³°å€¼è´Ÿè½½ã€‚

## å¹¶å‘é›†åˆ---çº¿ç¨‹å®‰å…¨çš„å®¹å™¨

| é›†åˆç±»å‹  | çº¿ç¨‹å®‰å…¨å®ç°                                                                    | åŸç†                                         |
| ----- | ------------------------------------------------------------------------- | ------------------------------------------ |
| Map   | `ConcurrentHashMap`                                                       | **åˆ†æ®µé”ï¼ˆJDK 7ï¼‰â†’ CAS + synchronizedï¼ˆJDK 8+ï¼‰** |
| List  | `CopyOnWriteArrayList`                                                    | **å†™æ—¶å¤åˆ¶**ï¼ˆå†™åŠ é”ï¼Œè¯»æ— é”ï¼‰                          |
| Set   | `CopyOnWriteArraySet` / `ConcurrentSkipListSet`                           | åŸºäº CopyOnWrite æˆ–è·³è¡¨                         |
| Queue | `ConcurrentLinkedQueue`ï¼ˆæ— ç•Œï¼‰<br>`BlockingQueue`ï¼ˆæœ‰ç•Œï¼Œå¦‚ `ArrayBlockingQueue`ï¼‰ | æ— é”é“¾è¡¨ / é˜»å¡é˜Ÿåˆ—                                |
|       |                                                                           |                                            |
âœ… **é€‚ç”¨åœºæ™¯**ï¼š

- `ConcurrentHashMap`ï¼šç¼“å­˜ã€è®¡æ•°
- `CopyOnWriteArrayList`ï¼šç›‘å¬å™¨åˆ—è¡¨ï¼ˆè¯»å¤šå†™æå°‘ï¼‰
- `BlockingQueue`ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹

## åŒæ­¥å·¥å…·ç±»---çº¿ç¨‹åä½œåˆ©å™¨
### 1. `CountDownLatch`ï¼ˆå€’è®¡æ—¶é—¨é—©ï¼‰

> **ç­‰å¾… N ä¸ªä»»åŠ¡å®Œæˆåå†ç»§ç»­**
```java
CountDownLatch latch = new CountDownLatch(3);
// 3 ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œåï¼Œä¸»çº¿ç¨‹æ‰ç»§ç»­
latch.countDown(); // æ¯å®Œæˆä¸€ä¸ªä»»åŠ¡è°ƒç”¨ä¸€æ¬¡
latch.await();     // ä¸»çº¿ç¨‹ç­‰å¾…
```
âœ… åœºæ™¯ï¼šå¯åŠ¨æœåŠ¡ç­‰å¾…å¤šä¸ªç»„ä»¶åˆå§‹åŒ–å®Œæˆ

### 2. `CyclicBarrier`ï¼ˆå¾ªç¯æ …æ ï¼‰

> **N ä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œå…¨éƒ¨åˆ°è¾¾åä¸€èµ·ç»§ç»­ï¼ˆå¯é‡å¤ä½¿ç”¨ï¼‰**

```java
CyclicBarrier barrier = new CyclicBarrier(3, () -> {
    System.out.println("æ‰€æœ‰çº¿ç¨‹å·²åˆ°è¾¾ï¼Œå¼€å§‹ä¸‹ä¸€æ­¥ï¼");
});
// æ¯ä¸ªçº¿ç¨‹è°ƒç”¨ï¼š
barrier.await();
```
âœ… åœºæ™¯ï¼šå¤šçº¿ç¨‹å¹¶è¡Œè®¡ç®—ï¼ˆå¦‚åˆ†æ®µå¤„ç†å¤§æ–‡ä»¶ï¼‰

### 3. `Semaphore`ï¼ˆä¿¡å·é‡ï¼‰

> **æ§åˆ¶å¹¶å‘è®¿é—®æ•°é‡**ï¼ˆå¦‚æ•°æ®åº“è¿æ¥æ± ï¼‰

```java
Semaphore sem = new Semaphore(2); // æœ€å¤š2ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®
sem.acquire(); // è·å–è®¸å¯
// ... ä¸´ç•ŒåŒº
sem.release(); // é‡Šæ”¾
```
âœ… åœºæ™¯ï¼šé™æµã€èµ„æºæ± æ§åˆ¶

## 4.CompletableFuture
> æ”¯æŒ **é“¾å¼è°ƒç”¨ã€ç»„åˆã€å¼‚å¸¸å¤„ç†**

```java
CompletableFuture<String> future = CompletableFuture
    .supplyAsync(() -> fetchData())          // å¼‚æ­¥è·å–æ•°æ®
    .thenApply(data -> process(data))        // å¤„ç†
    .thenAccept(result -> save(result))      // ä¿å­˜
    .exceptionally(ex -> {
        log.error("å¤±è´¥", ex);
        return null;
    });
```
âœ… **ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡**ï¼š

- `thenCombine()`ï¼šä¸¤ä¸ª future éƒ½å®Œæˆååˆå¹¶ç»“æœ
- `allOf()` / `anyOf()`ï¼šç­‰å¾…æ‰€æœ‰ / ä»»ä¸€å®Œæˆ

##  AQSï¼ˆAbstractQueuedSynchronizerï¼‰â€”â€” JUC åº•å±‚åŸºçŸ³
> **æ‰€æœ‰é”å’ŒåŒæ­¥å™¨çš„çˆ¶ç±»**ï¼ˆå¦‚ ReentrantLockã€Semaphoreã€CountDownLatch éƒ½åŸºäº AQSï¼‰

#### AQS æ ¸å¿ƒæ€æƒ³ï¼š

- ç»´æŠ¤ä¸€ä¸ª **stateï¼ˆintï¼‰** è¡¨ç¤ºèµ„æºçŠ¶æ€
- é€šè¿‡ **CAS ä¿®æ”¹ state**
- çº¿ç¨‹ç«äº‰å¤±è´¥æ—¶ï¼Œè¿›å…¥ **CLH é˜Ÿåˆ—** ç­‰å¾…

#### è‡ªå®šä¹‰åŒæ­¥å™¨ç¤ºä¾‹ï¼ˆç®€å•ä¸å¯é‡å…¥é”ï¼‰ï¼š
```java
class MyLock {
    private final Sync sync = new Sync();

    private static class Sync extends AbstractQueuedSynchronizer {
        @Override
        protected boolean tryAcquire(int acquires) {
            return compareAndSetState(0, 1); // 0=æœªé”ï¼Œ1=å·²é”
        }

        @Override
        protected boolean tryRelease(int releases) {
            setState(0);
            return true;
        }
    }

    public void lock() { sync.acquire(1); }
    public void unlock() { sync.release(1); }
}
```

## JUCæœ€ä½³å®è·µ
1. **ä¼˜å…ˆä½¿ç”¨å¹¶å‘é›†åˆ**ï¼Œè€Œä¸æ˜¯è‡ªå·±åŠ é”
    - ç”¨ `ConcurrentHashMap` è€Œä¸æ˜¯ `synchronized Map`
2. **çº¿ç¨‹æ± å¿…é¡»è‡ªå®šä¹‰å‚æ•°**ï¼Œç¦æ­¢ç”¨ `Executors`
3. **é¿å…é”åµŒå¥—**ï¼Œé˜²æ­¢æ­»é”
4. **è¯»å¤šå†™å°‘** â†’ `ReadWriteLock` æˆ– `CopyOnWrite`
5. **é«˜å¹¶å‘è®¡æ•°** â†’ `LongAdder`ï¼ˆæ¯” AtomicInteger æ›´é«˜æ•ˆï¼‰
6. **å¼‚æ­¥ä»»åŠ¡** â†’ ç”¨ `CompletableFuture` è€Œä¸æ˜¯ `Future.get


## volatile
volatile ä¿è¯ å˜é‡å¯è§æ€§å’Œæœ‰åºæ€§
### **æ²¡æœ‰ volatile ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ**

#### **å¯¹è±¡åˆ›å»ºçš„ä¸‰ä¸ªæ­¥éª¤ï¼ˆå¯èƒ½é‡æ’åºï¼‰**


```java

// instance = new Singleton(); å®é™…åŒ…å«ï¼š
memory = allocate();    // 1. åˆ†é…å†…å­˜ç©ºé—´
ctorInstance(memory);   // 2. åˆå§‹åŒ–å¯¹è±¡ï¼ˆè°ƒç”¨æ„é€ æ–¹æ³•ï¼‰
instance = memory;      // 3. å°†å¼•ç”¨èµ‹å€¼ç»™ instance

// å¯èƒ½è¢«é‡æ’åºä¸ºï¼š
memory = allocate();
instance = memory;      // âŒ å¼•ç”¨å·²èµ‹å€¼ï¼Œä½†å¯¹è±¡æœªåˆå§‹åŒ–ï¼
ctorInstance(memory);   // è¿™æ—¶å…¶ä»–çº¿ç¨‹å¯èƒ½æ‹¿åˆ°æœªåˆå§‹åŒ–çš„å¯¹è±¡
```

volatileæœ‰åºæ€§ **ä¸€å¥è¯æ€»ç»“ï¼šæœ‰åºæ€§å½±å“çš„æ˜¯ç¨‹åºä¸­æ‰€æœ‰å†…å­˜æ“ä½œï¼ˆè¯»/å†™ï¼‰çš„æ‰§è¡Œé¡ºåºï¼Œè€Œä¸ä»…ä»…æ˜¯å˜é‡èµ‹å€¼**ã€‚


## CPUè‡ªæ—‹
**CPUè‡ªæ—‹å°±æ˜¯â€œå ç€CPUä¸åœæ£€æŸ¥ï¼Œç›´åˆ°æ¡ä»¶è¾¾æˆåæ‰ç»§ç»­æ‰§è¡Œã€‚



## synchronized è¯¯ç”¨é—®é¢˜
å½“ç„¶å¯ä»¥ï¼ä»¥ä¸‹æ˜¯ä¸€ä»½ **`synchronized` æ–¹æ³•çº¿ç¨‹å®‰å…¨é€ŸæŸ¥è¡¨**ï¼Œ**é‡ç‚¹æ ‡æ³¨çº¿ç¨‹ä¸å®‰å…¨çš„å…¸å‹åœºæ™¯**ï¼Œæ–¹ä¾¿ä½ å¿«é€ŸæŸ¥é˜…å’Œé¿å‘ã€‚

---

# ğŸ”’ `synchronized` æ–¹æ³•çº¿ç¨‹å®‰å…¨é€ŸæŸ¥è¡¨

| ç±»å‹                 | ä»£ç ç¤ºä¾‹                                                                                                                                         | é”å¯¹è±¡                    | æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ                      | å…³é”®è¯´æ˜                                            |
| ------------------ | -------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------- | ---------------------------- | ----------------------------------------------- |
| âœ… **å®ä¾‹æ–¹æ³• + å®ä¾‹å˜é‡**  | ```java<br>public synchronized void add() {<br>    count++; // count æ˜¯å®ä¾‹å˜é‡<br>}```                                                           | `this`ï¼ˆå½“å‰å¯¹è±¡å®ä¾‹ï¼‰         | âœ… **å®‰å…¨**ï¼ˆå½“å¤šä¸ªçº¿ç¨‹æ“ä½œ**åŒä¸€ä¸ªå¯¹è±¡**æ—¶ï¼‰  | å¤šçº¿ç¨‹è°ƒç”¨ **åŒä¸€ä¸ªå¯¹è±¡** çš„æ–¹æ³• â†’ å®‰å…¨                        |
| âŒ **å®ä¾‹æ–¹æ³• + å¤šä¸ªå¯¹è±¡**  | ```java<br>Counter c1 = new Counter();<br>Counter c2 = new Counter();<br>// thread1: c1.add()<br>// thread2: c2.add()```                     | `c1` å’Œ `c2` å„è‡ªçš„ `this` | âŒ **ä¸å®‰å…¨**ï¼ˆå¦‚æœ `count` åº”è¯¥å…¨å±€å…±äº«ï¼‰ | æ¯ä¸ªå¯¹è±¡æœ‰è‡ªå·±çš„é”ï¼Œ**æ— æ³•ä¿æŠ¤è·¨å¯¹è±¡çš„å…±äº«çŠ¶æ€**                      |
| âœ… **é™æ€æ–¹æ³• + é™æ€å˜é‡**  | ```java<br>public static synchronized void incr() {<br>    globalCount++; // é™æ€å˜é‡<br>}```                                                    | `MyClass.class`ï¼ˆç±»å¯¹è±¡ï¼‰   | âœ… **å®‰å…¨**                     | é™æ€å˜é‡æ˜¯å…¨å±€å…±äº«çš„ï¼Œé”æ˜¯ç±»å¯¹è±¡ï¼ˆå…¨å±€å”¯ä¸€ï¼‰                          |
| âŒ **å®ä¾‹æ–¹æ³•ä½†æ“ä½œé™æ€å˜é‡**  | ```java<br>private static int x = 0;<br>public synchronized void bad() {<br>    x++;<br>}```                                                 | `this`ï¼ˆå®ä¾‹ï¼‰             | âŒ **ä¸å®‰å…¨ï¼**                   | å¤šä¸ªå¯¹è±¡æœ‰å¤šä¸ª `this` é”ï¼Œä½† `x` æ˜¯**åŒä¸€ä¸ªé™æ€å˜é‡** â†’ **é”é”™å¯¹è±¡ï¼** |
| âŒ **åªå†™åŠ é”ï¼Œè¯»ä¸åŠ é”**    | ```java<br>public synchronized void set(int v) { val = v; }<br>public int get() { return val; } // æœªåŒæ­¥```                                    | `this`                 | âŒ **ä¸å®‰å…¨**                    | è¯»æ“ä½œå¯èƒ½**çœ‹ä¸åˆ°æœ€æ–°å€¼**ï¼ˆç¼ºä¹å¯è§æ€§ä¿è¯ï¼‰                        |
| âŒ **è¿”å›å†…éƒ¨å¯å˜å¯¹è±¡å¼•ç”¨**   | ```java<br>private List<String> list = new ArrayList<>();<br>public synchronized List<String> getList() {<br>    return list; // å±é™©ï¼<br>}``` | `this`                 | âŒ **ä¸å®‰å…¨**                    | å¤–éƒ¨æ‹¿åˆ° `list` åå¯ç›´æ¥ä¿®æ”¹ï¼Œ**ç»•è¿‡é”**                      |
| âœ… **è¯»å†™éƒ½åŠ é” + è¿”å›å‰¯æœ¬** | ```java<br>public synchronized List<String> getList() {<br>    return new ArrayList<>(list);<br>}```                                         | `this`                 | âœ… **å®‰å…¨**                     | é˜²æ­¢å¤–éƒ¨ä¿®æ”¹å†…éƒ¨çŠ¶æ€                                      |

---

## âš ï¸ é‡ç‚¹ï¼š**æœ€å¸¸è§çº¿ç¨‹ä¸å®‰å…¨çš„ 3 ä¸ªé™·é˜±**

### é™·é˜± 1ï¼šâŒ **ç”¨å®ä¾‹æ–¹æ³•ä¿æŠ¤é™æ€å˜é‡**
```java
private static int count = 0;
public synchronized void increment() { // é” thisï¼Œä½† count æ˜¯é™æ€çš„ï¼
    count++;
}
```
> **é—®é¢˜**ï¼š10 ä¸ª `MyClass` å¯¹è±¡ â†’ 10 æŠŠä¸åŒçš„é” â†’ é™æ€å˜é‡ `count` æ— ä¿æŠ¤ï¼  
> **ä¿®å¤**ï¼šæ”¹ç”¨ `static synchronized` æ–¹æ³•ï¼Œæˆ–é” `MyClass.class`

---

### é™·é˜± 2ï¼šâŒ **å¤šä¸ªå¯¹è±¡å®ä¾‹ï¼Œè¯¯ä»¥ä¸ºå…¨å±€åŒæ­¥**
```java
// ä½ ä»¥ä¸ºåœ¨â€œåŒä¸€ä¸ªè®¡æ•°å™¨â€ä¸Šæ“ä½œï¼Œå®é™…æ˜¯å¤šä¸ªç‹¬ç«‹è®¡æ•°å™¨
new Thread(() -> new Counter().increment()).start();
new Thread(() -> new Counter().increment()).start();
```
> **ç»“æœ**ï¼šä¸¤ä¸ªçº¿ç¨‹å„æ“ä½œè‡ªå·±çš„ `Counter`ï¼Œ`count` æœ€ç»ˆæ˜¯ 1 è€Œä¸æ˜¯ 2  
> **é€‚ç”¨åœºæ™¯**ï¼šåªæœ‰å½“ä½ **æ˜ç¡®åªç”¨ä¸€ä¸ªå®ä¾‹**æ—¶ï¼Œå®ä¾‹æ–¹æ³•åŒæ­¥æ‰æœ‰æ•ˆ

---

### é™·é˜± 3ï¼šâŒ **æ³„éœ²å†…éƒ¨å¯å˜çŠ¶æ€**
```java
public synchronized Date getLastModified() {
    return lastModified; // Date æ˜¯å¯å˜å¯¹è±¡ï¼
}
```
> **é£é™©**ï¼šè°ƒç”¨è€…å¯ä»¥ `getLastModified().setTime(0)`ï¼Œç›´æ¥ä¿®æ”¹å†…éƒ¨çŠ¶æ€ï¼  
> **ä¿®å¤**ï¼šè¿”å›**ä¸å¯å˜å¯¹è±¡**æˆ–**å‰¯æœ¬** â†’ `return new Date(lastModified.getTime());`

---

## âœ… å®‰å…¨ä½¿ç”¨ checklist

âœ… é—®è‡ªå·±ï¼š
- [ ] å…±äº«æ•°æ®æ˜¯**å®ä¾‹å˜é‡**è¿˜æ˜¯**é™æ€å˜é‡**ï¼Ÿ
- [ ] æ‰€æœ‰è¯»å†™æ“ä½œæ˜¯å¦éƒ½é€šè¿‡**åŒä¸€æŠŠé”**ï¼Ÿ
- [ ] æ˜¯å¦æœ‰**è¿”å›å†…éƒ¨å¯å˜å¯¹è±¡**ï¼Ÿ
- [ ] æ˜¯å¦æœ‰**å¤šä¸ªå¯¹è±¡å®ä¾‹**å´éœ€è¦å…¨å±€åŒæ­¥ï¼Ÿ

---

## ğŸ’¡ ä¸€å¥è¯å£è¯€

> **â€œå®ä¾‹å˜é‡ç”¨å®ä¾‹é”ï¼Œé™æ€å˜é‡ç”¨ç±»é”ï¼›  
> è¯»å†™éƒ½è¦åŠ åŒæ­¥ï¼Œåˆ«æŠŠå†…éƒ¨å¼•ç”¨éœ²ã€‚â€**

---

è¿™ä»½é€ŸæŸ¥è¡¨å¯æ‰“å°æˆ–æ”¶è—ï¼Œå†™å¤šçº¿ç¨‹ä»£ç æ—¶å¯¹ç…§æ£€æŸ¥ï¼Œèƒ½é¿å… **90% çš„ `synchronized` è¯¯ç”¨é—®é¢˜**ï¼